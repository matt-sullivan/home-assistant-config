substitutions:
  device_name: lights-emily
  friendly_name: "Emily Lights"
  deviceicon: "mdi:light-recessed"
# Pin assignments for 2 gang 2 way model. (6952HA)
# P6 - Relay 2
# P9 - Power Sensor Switch 2
# P23 - Switch 2

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}

bk72xx:
  board: wb3s

# Enable logging
logger:
  level: DEBUG

# Enable Home Assistant API
api:
  reboot_timeout: 24h
  encryption:
    key: "qRWAO5qNlxXIPaFK4/uw5cG8gXDK7/nf/Bc8iz97P9Y="

ota:
  platform: esphome
  password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  reboot_timeout: 1h

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Lights-Emily Fallback Hotspot"
    password: !secret fallback_password

web_server:
  port: 80

captive_portal:

sensor:
  - platform: wifi_signal
    name: ${device_name} Wifi Signal Strength
    update_interval: 60s
  - platform: uptime
    name: "${device_name} Uptime"
    filters:
      - lambda: return x / 86400.0;
    unit_of_measurement: "d"
    accuracy_decimals: 1
    update_interval: 5min

output:
  # status led
  - platform: gpio
    pin: P24
    id: status_led_output
    inverted: true
    
  # Relay 1
  - platform: gpio
    pin: P14
    id: relay1

light:

  # status Led
  - platform: binary
    name: "${friendly_name} status_led"
    output: status_led_output
    id: status
    
## ------------ ##
##     Light    ##
## ------------ ##
  # Light - keeping as internal as I found it worked but if you used the other switch 2-way switch, that HA would say the light was off when the light was actually on.
  # Using the Switch at the bottom of the config to keep everything in order. But then in HA you have to set the Switch that shows up to show up as a Light.
  - platform: binary
    name: "${friendly_name} light"
    icon: ${deviceicon}
    output: relay1
    id: light1
   

## ----------------- ##
##      Buttons      ##
## ----------------- ##
binary_sensor:
  # Top (or only) button
  - platform: gpio
    id: button
    name: "${friendly_name} Button"
    pin:
      number: P26
      inverted: true
      mode: INPUT_PULLUP
    on_press:
      - light.toggle: light1

  - platform: gpio
    id: power_status_1
    pin:
      number: P8
      mode: INPUT_PULLUP
      inverted: true  
    name: "Power status 1"


## ---------------- ##
##     Switches     ##
## ---------------- ##
switch:
  - platform: restart
    name: "${friendly_name} REBOOT"

  # Keep the light in HA in sync when using 2nd phyiscal switch
  - platform: template
    name: ${friendly_name}
    id: lounge_deta_2way_single_gang_template
    icon: ${deviceicon}
    lambda: |-
      if (id(power_status_1).state) {
        return true;
      } else {
        return false;
      }
    turn_on_action:
    - if:
        condition:
          - binary_sensor.is_off: power_status_1
        then:
          - light.toggle: light1
    turn_off_action:
    - if:
        condition:
          - binary_sensor.is_on: power_status_1
        then:
          - light.toggle: light1
